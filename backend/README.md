# äº®è½¦æƒ  IoT ç®¡ç†ç³»ç»Ÿåç«¯

## é¡¹ç›®ç®€ä»‹

äº®è½¦æƒ  IoT ç®¡ç†ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäº NestJS çš„ä¼ä¸šçº§åç«¯æœåŠ¡ï¼Œä¸ºæ™ºèƒ½è®¾å¤‡ç®¡ç†ã€å•†æˆ·é—¨åº—è¿è¥å’Œå¹³å°ç®¡ç†æä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚

## æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: NestJS 10.x
- **æ•°æ®åº“**: MySQL 8.0
- **ç¼“å­˜**: Redis 7.x
- **ORM**: TypeORM
- **è®¤è¯**: JWT
- **æ–‡æ¡£**: Swagger/OpenAPI
- **å®¹å™¨åŒ–**: Docker & Docker Compose

## åŠŸèƒ½ç‰¹æ€§

### ğŸ¢ å¹³å°ç®¡ç†ç³»ç»Ÿ (Admin)
- **ä»ªè¡¨ç›˜**: å®æ—¶æ•°æ®ç»Ÿè®¡å’Œå¯è§†åŒ–å›¾è¡¨
- **ç”¨æˆ·ç®¡ç†**: ç”¨æˆ·è´¦æˆ·ã€è§’è‰²æƒé™ç®¡ç†
- **å•†æˆ·ç®¡ç†**: å•†æˆ·æ³¨å†Œå®¡æ ¸ã€èµ„è´¨ç®¡ç†
- **é—¨åº—ç®¡ç†**: é—¨åº—ä¿¡æ¯ã€å‘˜å·¥é…ç½®
- **è®¾å¤‡ç®¡ç†**: è®¾å¤‡æ³¨å†Œã€çŠ¶æ€ç›‘æ§ã€è¿œç¨‹æ§åˆ¶
- **è®¢å•ç®¡ç†**: è®¢å•æŸ¥è¯¢ã€çŠ¶æ€è·Ÿè¸ªã€æ•°æ®åˆ†æ
- **åº“å­˜å‘Šè­¦**: åº“å­˜ç›‘æ§ã€è‡ªåŠ¨å‘Šè­¦ã€è¡¥è´§æé†’
- **å®¡è®¡æ—¥å¿—**: æ“ä½œè®°å½•ã€å®‰å…¨å®¡è®¡
- **ç³»ç»Ÿå·¥å…·**: æ•°æ®å¯¼å‡ºã€ç³»ç»Ÿé…ç½®

### ğŸª å•†æˆ·é—¨åº—ç³»ç»Ÿ (Merchant)
- **é—¨åº—èµ„æ–™**: é—¨åº—ä¿¡æ¯ç®¡ç†ã€è¥ä¸šè®¾ç½®
- **å‘˜å·¥ç®¡ç†**: å‘˜å·¥è´¦æˆ·ã€æƒé™åˆ†é…
- **è®¾å¤‡ç›‘æ§**: è®¾å¤‡çŠ¶æ€ã€è¿è¡Œæ•°æ®ã€æ•…éšœæŠ¥è­¦
- **åº“å­˜ç®¡ç†**: åº“å­˜æŸ¥è¯¢ã€å‘Šè­¦è®¾ç½®ã€è¡¥è´§ç”³è¯·
- **è®¢å•æŠ¥è¡¨**: é”€å”®ç»Ÿè®¡ã€æ”¶ç›Šåˆ†æã€è¶‹åŠ¿å›¾è¡¨
- **æ•°æ®å¯¼å‡º**: æŠ¥è¡¨ä¸‹è½½ã€æ•°æ®å¤‡ä»½

### ğŸ” æƒé™ç³»ç»Ÿ (RBAC)
- **å¹³å°ç®¡ç†å‘˜** (platform_admin): å…¨ç³»ç»Ÿç®¡ç†æƒé™
- **å•†æˆ·** (merchant): å•†æˆ·çº§æ•°æ®ç®¡ç†æƒé™
- **é—¨åº—ç»ç†** (store_manager): é—¨åº—çº§ç®¡ç†æƒé™
- **é—¨åº—å‘˜å·¥** (store_staff): åŸºç¡€æ“ä½œæƒé™

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Node.js >= 18.0.0
- npm >= 9.0.0
- Docker & Docker Compose
- MySQL 8.0+
- Redis 7.0+

### å®‰è£…ä¾èµ–

```bash
npm install
```

### ç¯å¢ƒé…ç½®

å¤åˆ¶ç¯å¢ƒé…ç½®æ–‡ä»¶å¹¶ä¿®æ”¹ç›¸å…³é…ç½®ï¼š

```bash
cp .env.example .env
```

é…ç½®è¯´æ˜ï¼š

```env
# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=sw63828
DB_DATABASE=iot_management

# Redisé…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWTé…ç½®
JWT_SECRET=your-super-secret-jwt-key-here
JWT_EXPIRES_IN=7d

# åº”ç”¨é…ç½®
APP_PORT=8000
APP_ENV=development
```

### å¯åŠ¨æœåŠ¡

#### ä½¿ç”¨ Docker Compose (æ¨è)

```bash
# å¯åŠ¨æ•°æ®åº“å’Œç¼“å­˜æœåŠ¡
docker-compose up -d

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run start:dev
```

#### æ‰‹åŠ¨å¯åŠ¨

```bash
# ç¡®ä¿ MySQL å’Œ Redis æœåŠ¡å·²å¯åŠ¨

# è¿è¡Œæ•°æ®åº“è¿ç§»
npm run migration:run

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run start:dev
```

### è®¿é—®æœåŠ¡

- **API æœåŠ¡**: http://localhost:8000
- **API æ–‡æ¡£**: http://localhost:8000/api/docs
- **phpMyAdmin**: http://localhost:8080 (ç”¨æˆ·å: root, å¯†ç : sw63828)

## API æ–‡æ¡£

### å¹³å°ç®¡ç† API

#### ä»ªè¡¨ç›˜ç»Ÿè®¡
```http
GET /api/v1/admin/dashboard/stats
```

#### ç”¨æˆ·ç®¡ç†
```http
GET    /api/v1/admin/users          # è·å–ç”¨æˆ·åˆ—è¡¨
POST   /api/v1/admin/users          # åˆ›å»ºç”¨æˆ·
GET    /api/v1/admin/users/:id      # è·å–ç”¨æˆ·è¯¦æƒ…
PUT    /api/v1/admin/users/:id      # æ›´æ–°ç”¨æˆ·
DELETE /api/v1/admin/users/:id      # åˆ é™¤ç”¨æˆ·
```

#### å•†æˆ·ç®¡ç†
```http
GET    /api/v1/admin/merchants      # è·å–å•†æˆ·åˆ—è¡¨
POST   /api/v1/admin/merchants      # åˆ›å»ºå•†æˆ·
GET    /api/v1/admin/merchants/:id  # è·å–å•†æˆ·è¯¦æƒ…
PUT    /api/v1/admin/merchants/:id  # æ›´æ–°å•†æˆ·
```

#### è®¾å¤‡ç®¡ç†
```http
GET    /api/v1/admin/devices        # è·å–è®¾å¤‡åˆ—è¡¨
POST   /api/v1/admin/devices        # æ³¨å†Œè®¾å¤‡
GET    /api/v1/admin/devices/:id    # è·å–è®¾å¤‡è¯¦æƒ…
PUT    /api/v1/admin/devices/:id    # æ›´æ–°è®¾å¤‡
GET    /api/v1/admin/devices/:id/logs # è·å–è®¾å¤‡æ—¥å¿—
```

### å•†æˆ·é—¨åº— API

#### é—¨åº—ç®¡ç†
```http
GET    /api/v1/merchant/stores      # è·å–é—¨åº—åˆ—è¡¨
POST   /api/v1/merchant/stores      # åˆ›å»ºé—¨åº—
GET    /api/v1/merchant/stores/:id  # è·å–é—¨åº—è¯¦æƒ…
PUT    /api/v1/merchant/stores/:id  # æ›´æ–°é—¨åº—
```

#### å‘˜å·¥ç®¡ç†
```http
GET    /api/v1/merchant/staff       # è·å–å‘˜å·¥åˆ—è¡¨
POST   /api/v1/merchant/staff       # æ·»åŠ å‘˜å·¥
PUT    /api/v1/merchant/staff/:id   # æ›´æ–°å‘˜å·¥
```

#### è®¾å¤‡ç›‘æ§
```http
GET    /api/v1/merchant/devices     # è·å–è®¾å¤‡åˆ—è¡¨
GET    /api/v1/merchant/devices/:id/status # è·å–è®¾å¤‡çŠ¶æ€
```

## æ•°æ®åº“ç»“æ„

### æ ¸å¿ƒå®ä½“

- **users**: ç”¨æˆ·è´¦æˆ·ä¿¡æ¯
- **merchants**: å•†æˆ·ä¿¡æ¯
- **stores**: é—¨åº—ä¿¡æ¯
- **devices**: è®¾å¤‡ä¿¡æ¯
- **orders**: è®¢å•æ•°æ®
- **inventory**: åº“å­˜ä¿¡æ¯
- **alerts**: å‘Šè­¦è®°å½•
- **audit_logs**: å®¡è®¡æ—¥å¿—

### å…³ç³»è¯´æ˜

```
users (1:N) merchants (1:N) stores (1:N) devices
                                    â†“
                              orders (N:1) users
                                    â†“
                              inventory (1:1) stores
```

## å¼€å‘æŒ‡å—

### é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ admin/           # å¹³å°ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ merchant/        # å•†æˆ·é—¨åº—æ¨¡å—
â”‚   â”œâ”€â”€ auth/           # è®¤è¯æˆæƒæ¨¡å—
â”‚   â”œâ”€â”€ audit/          # å®¡è®¡æ—¥å¿—æ¨¡å—
â”‚   â””â”€â”€ common/         # å…¬å…±æ¨¡å—
â”œâ”€â”€ entities/           # æ•°æ®åº“å®ä½“
â”œâ”€â”€ config/            # é…ç½®æ–‡ä»¶
â”œâ”€â”€ guards/            # è·¯ç”±å®ˆå«
â”œâ”€â”€ interceptors/      # æ‹¦æˆªå™¨
â”œâ”€â”€ decorators/        # è£…é¥°å™¨
â””â”€â”€ utils/             # å·¥å…·å‡½æ•°
```

### ä»£ç è§„èŒƒ

- ä½¿ç”¨ TypeScript ä¸¥æ ¼æ¨¡å¼
- éµå¾ª ESLint å’Œ Prettier è§„èŒƒ
- ä½¿ç”¨ Swagger æ³¨è§£ç”Ÿæˆ API æ–‡æ¡£
- ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

### å¸¸ç”¨å‘½ä»¤

```bash
# å¼€å‘
npm run start:dev      # å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run build          # æ„å»ºé¡¹ç›®
npm run test           # è¿è¡Œæµ‹è¯•

# æ•°æ®åº“
npm run migration:generate  # ç”Ÿæˆè¿ç§»æ–‡ä»¶
npm run migration:run       # æ‰§è¡Œè¿ç§»
npm run migration:revert    # å›æ»šè¿ç§»

# ä»£ç è´¨é‡
npm run lint           # ä»£ç æ£€æŸ¥
npm run format         # ä»£ç æ ¼å¼åŒ–
```

## éƒ¨ç½²è¯´æ˜

### Docker éƒ¨ç½²

```bash
# æ„å»ºé•œåƒ
docker build -t lch-backend .

# è¿è¡Œå®¹å™¨
docker run -d -p 8000:8000 --name lch-backend lch-backend
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®

1. è®¾ç½®ç¯å¢ƒå˜é‡ `NODE_ENV=production`
2. é…ç½®ç”Ÿäº§æ•°æ®åº“è¿æ¥
3. è®¾ç½®å¼ºå¯†ç å’Œå®‰å…¨å¯†é’¥
4. å¯ç”¨ HTTPS
5. é…ç½®æ—¥å¿—æ”¶é›†
6. è®¾ç½®ç›‘æ§å‘Šè­¦

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   - æ£€æŸ¥æ•°æ®åº“æœåŠ¡æ˜¯å¦å¯åŠ¨
   - éªŒè¯è¿æ¥é…ç½®æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤ç½‘ç»œè¿é€šæ€§

2. **Redis è¿æ¥å¤±è´¥**
   - æ£€æŸ¥ Redis æœåŠ¡çŠ¶æ€
   - éªŒè¯è¿æ¥å‚æ•°
   - æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

3. **ç«¯å£å ç”¨**
   - ä½¿ç”¨ `netstat -ano | findstr :8000` æŸ¥æ‰¾å ç”¨è¿›ç¨‹
   - ç»ˆæ­¢å ç”¨è¿›ç¨‹æˆ–æ›´æ¢ç«¯å£

4. **æƒé™é—®é¢˜**
   - æ£€æŸ¥ç”¨æˆ·è§’è‰²é…ç½®
   - éªŒè¯ JWT Token æœ‰æ•ˆæ€§
   - ç¡®è®¤ API æƒé™è®¾ç½®

## è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤ä»£ç å˜æ›´
4. æ¨é€åˆ°åˆ†æ”¯
5. åˆ›å»º Pull Request

## è®¸å¯è¯

MIT License

## è”ç³»æ–¹å¼

- é¡¹ç›®ç»´æŠ¤è€…: å¼€å‘å›¢é˜Ÿ
- é‚®ç®±: dev@liangchehui.com
- æ–‡æ¡£: [é¡¹ç›®æ–‡æ¡£](https://docs.liangchehui.com)