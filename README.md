亮车惠 · 自助洗车系统 - 项目技术与开发上下文 (V2 - 架构增强版)1. 项目概述本项目旨在打造“亮车惠 · 自助洗车系统”。系统通过微信公众号 H5 页面，为用户（车主）提供自助洗车、支付结算、订单查询服务；为加盟商户和平台管理员提供统一的 PC端 + H5端运营后台，实现设备管理、收益统计、多门店运营。整个系统分为三大角色：用户、商户、平台，并基于 智链物联设备 (hbzhilian.com) 实现 IoT 化运营。2. 业务场景描述 (IoT 实际运行流程)设备接入与状态上报设备联网启动时，上报 上线通知 (cmd: online) → 系统标记为“可用”。设备掉线时，上报 下线通知 (cmd: offline) → 系统及时更新状态，避免无效订单。设备运行中，周期性上报 ICCID + 配置参数 (cmd: 13)，后台保存 SIM 卡号、最大工作时长、恒温参数等运行配置。用户验证与启动设备用户通过微信公众号 H5 登录（手机号+密码 / 微信授权），绑定账号。登录成功后，用户扫码选择设备，点击“启动洗车”。平台调用智链 API 下发 启动指令 (cmd: 09)，设备执行后上报 启动成功反馈（含订单号、启动结果）。设备运行与异常监控设备运行时，可能上报 缺水/缺液告警 (cmd: 19)。后台系统接收告警 → 推送通知给商户运维人员，保证耗材及时补充。结算与订单生成用户完成洗车 → 设备主动上报 结算信息 (cmd: 10)，包括消费金额、用水用液时长等。平台生成订单，调用 微信支付 API 自动扣费。订单归属到对应的 商户与设备，支持 多加盟店分账管理。通过此流程，系统实现了：✅ 扫码即用，自助完成洗车✅ 设备实时监控 + 异常告警✅ 自动生成结算订单并完成支付✅ 多商户分账与收益透明化3. 核心用户角色用户（车主）: 通过 H5 端扫码使用设备、支付订单、管理个人消费记录。商户（加盟店主）: 通过 PC/H5 后台管理名下门店、设备状态、员工账户、营收报表。平台管理员: 统一监管全平台商户、设备、财务和活动运营。4. 架构关键点 (Architectural Considerations)4.1. API 设计规范版本化: 所有API都应包含版本号，例如 /api/v1。角色隔离: 不同角色的API使用不同的路由前缀，便于统一鉴权和管理。平台管理员: /api/v1/admin/...商户: /api/v1/merchant/...普通用户: /api/v1/user/...RESTful风格: 遵循标准的RESTful设计原则。4.2. 用户认证与鉴权 (Auth)注册: 手机号 + 密码，密码在Service层使用 bcryptjs 加密存储。登录: 手机号 + 密码验证成功后，生成 JWT Token 返回。JWT Payload: Token 的载荷 (payload) 中必须包含 userId 和 role ('user' | 'merchant' | 'platform_admin')，用于后续的鉴权。多角色鉴权: 所有需要登录的接口统一使用 NestJS 的 AuthGuard 进行保护。守卫会解析 JWT 中的 role 字段，判断当前用户是否有权访问目标路由（例如，访问 /api/v1/admin 开头的接口，role 必须是 platform_admin）。4.3. 数据校验 (DTOs)所有写入型操作（POST, PATCH）的 Controller 方法，都必须使用 DTO (Data Transfer Object) 来接收和校验请求体。DTO 文件中必须使用 class-validator 装饰器来定义详细的校验规则。在 main.ts 中必须全局启用 ValidationPipe，以实现自动化的请求体验证。4.4. 数据库事务对于涉及多个数据表写入的操作（例如：创建订单、更新用户余额、生成分账记录），必须在 Service 层使用数据库事务（如 TypeORM 的 transaction）来确保操作的原子性，保证数据一致性。4.5. 全局异常处理与日志异常过滤器: 建议创建一个全局的异常过滤器 (Exception Filter)，捕获所有未处理的异常，将其格式化为统一的JSON错误响应返回给前端。日志记录: 引入日志模块（如 NestJS 内置的 Logger 或 pino），对关键操作（如用户登录、支付、设备指令）、错误异常和设备回调数据进行详细记录，便于问题排查和审计。5. 技术栈方案前端 (Frontend): Vue 3H5 端 → Vant UIPC 管理端 → Element Plus后端 (Backend): NestJS + TypeScript数据库 (Database): MySQL 8.0（主库），Redis 7（缓存、Session、限流）部署 (Deployment): Docker + Docker ComposeIoT 通信: 调用智链物联 RESTful API 完成设备指令下发与数据回调对接。6. 项目结构 (Monorepo)/lch/
├── backend/         # NestJS 后端项目
│   ├── src/
│   ├── package.json
│   └── Dockerfile
├── frontend/        # Vue 3 前端项目
└── docker-compose.yml
7. 后端核心模块规划UserModule: 用户（车主）的注册、登录、信息管理。AuthModule: JWT 策略、全局认证守卫、多角色鉴权逻辑。MerchantModule: 商户的注册、登录、门店与员工管理。PlatformModule: 平台管理员的账号、角色与权限管理。DeviceModule: 设备状态管理、指令下发、数据回调统一处理。OrderModule: 订单创建、支付结算、分账与对账。SharedModule: 存放全局共享的服务，如日志、配置等。8. 开发环境与工作流 (关键点)不使用 Volume 挂载: 为保证开发环境的绝对纯净，避免因本地 node_modules 污染导致的“找不到模块”问题，docker-compose.yml 中不挂载 volumes。开发流程: 本地修改代码后 → 执行 docker compose build 重新构建镜像 → 执行 docker compose up -d 重启服务。日志查看: docker compose logs -f backend。9. 首要开发任务 (MVP 阶段)实现 UserModule + AuthModule，完整打通“手机号+密码”注册与登录流程，并返回包含正确 userId 和 role 的 JWT Token。实现多角色 AuthGuard，并分别创建受保护的测试接口（如 /api/v1/admin/test, /api/v1/user/test）来验证鉴权有效性。实现 设备回调统一接收接口 (/api/v1/device/callback)，能接收智链物联上报的各类数据（如上线、下线、结算）并打印日志。实现 设备启动接口 (/api/v1/user/device/start)，在通过鉴权后，能模拟调用智链 API 下发启动指令。功能清单 (四大端)(你提供的功能清单非常完整和出色，此处保持原样)1. 平台后台管理系统 (Platform Admin)...2. 商户管理系统 (Merchant Admin)...3. 商户前端 (Merchant H5)...4. 用户前端 (User H5)...